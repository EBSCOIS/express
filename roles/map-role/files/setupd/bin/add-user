#!/opt/pf9/setupd/bin/python2

import logging
import sys

from argparse import ArgumentParser
from firkinize.configstore.consul import Consul

logging.basicConfig(level=logging.DEBUG)
LOG = logging.getLogger(__name__)

def parse_args():
    parser = ArgumentParser(
        description='Add a keystone endpoint to the config store.')
    parser.add_argument('--config-url', default='http://localhost:8500',
        help='Address of the config node, default http://localhost:8500')
    parser.add_argument('--customer-id', help='Customer id', required=True)
    parser.add_argument('--email', help='username', required=True)
    parser.add_argument('--password', help='password', required=True)
    parser.add_argument('--role', help='role', required=True)
    parser.add_argument('--project', help='project name', required=True)
    return parser.parse_args()

def main():
    args = parse_args()
    consul = Consul(args.config_url)
    key = 'customers/%s/keystone/users/%s/%%s' % (args.customer_id, args.email)
    txn = {
        key % 'email': args.email,
        key % 'password': args.password,
        key % 'role': args.role,
        key % 'project': args.project,
    }
    consul.kv_put_txn(txn)

if __name__ == '__main__':
    sys.exit(main())
