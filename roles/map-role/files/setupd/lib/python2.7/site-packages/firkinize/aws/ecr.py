"""
Amazon ECR functions
"""

# Copyright (c) 2017 Platform9 Systems

import boto3
import urlparse
import base64
import logging

LOG = logging.getLogger(__name__)


def get_ecr_login_info(aws_access_key_id, aws_secret_key, registry_url, region_name='us-west-1'):
    session = boto3.session.Session(aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_key, region_name=region_name)

    # The URL could be blah.dkr.ecr.region.amazonaws.com or
    # https://blah.dkr.ecr.region.amazonaws.com
    url_info = urlparse.urlparse(registry_url)
    ecr_hostname = url_info.netloc or url_info.path

    if not ecr_hostname:
        raise Exception(
            'Could not determine ECR Registry information from %s' % registry_url)

    if not ecr_hostname.endswith('amazonaws.com'):
        raise Exception('Not an AWS-based registry: %s' % registry_url)

    # we just want the "blah" part
    registry_id = ecr_hostname.split('.')[0]

    ecr = session.client('ecr')
    auth_token_info = ecr.get_authorization_token(
            registryIds=[registry_id]
            )

    LOG.debug(auth_token_info)

    auth_user, auth_token = base64.b64decode(
            auth_token_info['authorizationData'][0]['authorizationToken']
            ).split(':', 1)

    return auth_user, auth_token
