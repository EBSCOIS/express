# Copyright (c) 2018 Platform9 systems. All rights reserved

import requests

def get_image_metatada(registry_fqdn, auth_user, auth_pwd, img_name, img_tag):
    url = 'https://%s/v2/%s/manifests/%s' % (
        registry_fqdn,
        img_name,
        img_tag
    )
    r = requests.get(url, auth=(auth_user, auth_pwd))
    r.raise_for_status()
    j = r.json()
    config = j.get('config')
    if not config:
        raise RuntimeError('image metadata missing expected config field')
    digest = config.get('digest')
    if not digest:
        raise RuntimeError('image config missing expected digest field')
    url = 'https://%s/v2/%s/blobs/%s' % (
        registry_fqdn,
        img_name,
        digest
    )
    r = requests.get(url, auth=(auth_user, auth_pwd))
    r.raise_for_status()
    j = r.json()
    return j
