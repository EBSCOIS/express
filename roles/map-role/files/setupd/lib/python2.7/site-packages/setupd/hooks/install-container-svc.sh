#!/bin/bash

set -e -x

IMG_NAME=$1
TAG_NAME=$2
LOG_DIR=$3
OPTIONS=$4

SVC_NAME=setupd-${IMG_NAME}.service
DEST_UNIT_FILE=/etc/systemd/system/${SVC_NAME}
CONTAINER_LOG_DIR=${LOG_DIR}/container-${IMG_NAME}

mkdir -p ${CONTAINER_LOG_DIR}

cat >${DEST_UNIT_FILE} <<EOS

[Unit]
Description=Platform9 auto-generated service file for ${IMG_NAME}:${TAG_NAME}
After=network.target

[Service]
Type=simple
PIDFile=/run/setupd-container-${IMG_NAME}.pid
EnvironmentFile=/etc/setupd-env
ExecStart=/usr/bin/docker run --name ${IMG_NAME} --network host \\
    -e CONFIG_HOST_AND_PORT=\${CONFIG_HOST_AND_PORT} \\
    -e CONFIG_URL=\${CONFIG_URL} \\
    -e CUSTOMER_ID=\${CUSTOMER_ID} \\
    -e REGION_ID=\${REGION_ID} \\
    -e CONSUL_HTTP_TOKEN=dummy \\
    -v ${CONTAINER_LOG_DIR}:/var/log \\
    ${OPTIONS} \\
    ${IMG_NAME}:${TAG_NAME}
ExecStartPre=-/usr/bin/docker kill ${IMG_NAME}
ExecStartPre=-/usr/bin/docker rm ${IMG_NAME}
ExecStop=/usr/bin/docker stop ${IMG_NAME}
Restart=on-failure

[Install]
WantedBy=multi-user.target

EOS

systemctl daemon-reload
systemctl enable ${SVC_NAME}
systemctl restart ${SVC_NAME}
