#!/usr/bin/env python
#
# Copyright (c) 2017 Platform9 Systems

import logging
from gevent import monkey
from gevent.pywsgi import WSGIServer, LoggingLogAdapter
from setupd.http import app
from logging.handlers import SysLogHandler
from iniparse import RawConfigParser

LOG_FILE = '/var/log/pf9/setupd.log'
SETUPD_CONFIG = '/etc/pf9/setupd.conf'

if __name__ == '__main__':
    # Patch subprocess so it can be used by multiple greenlets
    monkey.patch_all()

    config = RawConfigParser()
    config.read(SETUPD_CONFIG)

    if config.has_section('logging') and config.has_option('logging', 'level'):
        log_level = config.get('logging', 'level').upper()
    else:
        log_level = 'INFO'
    log_level = logging.getLevelName(log_level)

    log_handler = logging.FileHandler(LOG_FILE)
    log_handler.setLevel(log_level)
    for handler in app.logger.handlers:
        app.logger.removeHandler(handler)
    app.logger.addHandler(log_handler)
    
    http_server = WSGIServer(
            ('', 8076), app,
            log=app.logger,
            error_log=app.logger)
    http_server.serve_forever()
