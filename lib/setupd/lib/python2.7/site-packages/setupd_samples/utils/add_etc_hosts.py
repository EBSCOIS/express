#!/usr/bin/env python

import tempfile,sys, os
import shutil,argparse,logging

LOG=logging.getLogger(__name__)

def add_hosts_entry(ipaddr, hostnames):
    """
    Adds static DNS names to /etc/hosts. This is needed for local configuration
    to complete.
    """
    host_data = []
    if type(hostnames) in (str,unicode):
        hostnames = [hostnames]
    with open('/etc/hosts', 'r') as f:
        host_data = f.readlines()
    host_line = '%s %s\n' % (ipaddr, ' '.join(hostnames))
    if host_line in host_data:
        LOG.info('Already has a hosts entry, skipping...')
        return
    host_data.append(host_line)
    tmpf = tempfile.NamedTemporaryFile(delete=False)
    tmpf.write('\n'.join(host_data))
    tmpf.close()
    shutil.move(tmpf.name, '/etc/hosts')
    # Make sure it is world readable
    os.chmod('/etc/hosts', 0644)


def parse_args():
    ap = argparse.ArgumentParser(sys.argv[0],
            formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    ap.add_argument('--ip-address', required=True, dest='ip_address',
                    help='IP address')
    ap.add_argument('--hostname', required=True, dest='hostname',
                    help='hostname')
    return ap.parse_args()


if __name__ == '__main__':
    try:
        args = parse_args()
        add_hosts_entry(args.ip_address, args.hostname)
        print "Done"
    except Exception as ex:
        print "Operation failed"
        LOG.exception(ex)
        LOG.critical('Really bad things happened: %s', str(ex))
        sys.exit(1)

