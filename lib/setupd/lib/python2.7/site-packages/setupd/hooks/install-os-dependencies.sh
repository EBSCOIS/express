#!/bin/bash

set -e -x

CONSUL_VERSION=0.9.0
CONSUL_DL_URL="https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip"

TMPDIR=$(mktemp -d)
on_exit() {
    [ "x${TMPDIR}" != "x" ] && rm -rf $TMPDIR
}
trap on_exit EXIT

# Install a few packages we need upfront for docker
yum -y install yum-utils device-mapper-persistent-data lvm2 unzip

# Download and install consul
curl -o ${TMPDIR}/consul.zip "${CONSUL_DL_URL}"
unzip -o ${TMPDIR}/consul.zip -d /usr/local/bin
chmod +x /usr/local/bin/consul

# Add consul user/group and give it ownership of some necessary directories
groupadd consul || echo >&2 "consul group already exists?"
useradd -g consul consul || echo >&2 "consul user already exists?"
mkdir -p /var/lib/consul /etc/consul
chown consul:consul /var/lib/consul /etc/consul

# Add consul systemd
cat >/etc/systemd/system/consul-server.service <<EOS
[Unit]
Description=Consul Server Agent
After=network.target

[Service]
Type=simple
User=consul
Group=consul
PIDFile=/run/consul-server.pid
ExecStart=/usr/local/bin/consul agent -server -bind 127.0.0.1 -bootstrap-expect 1 -syslog -config-dir /etc/consul
Restart=on-failure

[Install]
WantedBy=multi-user.target

EOS

cat >/etc/consul/config.json <<EOS
{
    "datacenter": "platform9",
    "data_dir": "/var/lib/consul",
    "server": true,
    "addresses": {
        "http": "127.0.0.1"
    }
}

EOS

systemctl daemon-reload
systemctl enable consul-server
systemctl start consul-server


# install docker
cat > /etc/yum.repos.d/docker.repo <<EOS
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/main/centos/7/
enabled=1
gpgcheck=0

EOS
yum makecache fast

yum install -y "docker-engine-1.12.6"
mkdir -p /etc/docker
echo '{"storage-driver": "devicemapper"}' > /etc/docker/daemon.json
systemctl enable docker
systemctl start docker

curl -o /opt/pf9/setupd/bin/kubectl -LO https://storage.googleapis.com/kubernetes-release/release/v1.8.4/bin/linux/amd64/kubectl